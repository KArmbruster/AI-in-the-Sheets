## Technical Specifications

**1. Introduction**
This document outlines the technical specifications for a Google Apps Script designed to integrate the Google Gemini API directly into a Google Sheet. The script provides a custom function, `=GEMINI()`, enabling users to send data from specified cells to the Gemini API and receive the output in the cell where the formula is entered.

**2. Core Functionality**
The script's sole function is to act as a bridge between a Google Sheet and the Gemini API via a custom function. It will fetch content from one or more cells, use this content to query the Gemini API, and write the API's response back into the cell containing the function.

**3. Technical Requirements**
3.1. Environment
*   **Platform:** Google Sheets
*   **Scripting Language:** Google Apps Script (JavaScript-based)

3.2. External API Integration
*   **API:** Google Gemini API
*   **Authentication:** The script will use an API key for authentication. **This key must be manually set by the user in the Script Properties.**

3.3. Security
*   **API Key Storage:** To prevent exposing the API key directly in the code, it will be stored using the **PropertiesService** of Google Apps Script. The user must manually add their key to the script's project properties. This is the most secure method for storing credentials in Apps Script.

**4. Script Implementation**
4.1. Custom Function: `GEMINI()`
*   **Syntax:** `=GEMINI(prompt_range, [temperature])`
*   **Description:** This function takes a cell or a range of cells as the prompt for the Gemini API. If a range is provided, the contents of the cells are concatenated with spaces to form a single prompt.
*   **Parameters:**
    *   `prompt_range`: A single cell (e.g., `A2`) or a range (e.g., `A2:C2`) containing the input text.
    *   `temperature` (optional): A number between 0.0 and 1.0 to control response creativity. **Defaults to 0.0** for deterministic output.
*   **Returns:** The text generated by the Gemini API or a descriptive error message.
*   **Example Usage:** In cell D2, `=GEMINI(A2:C2, 0.5)` sends the combined contents of A2, B2, and C2 to Gemini and displays the result in D2.

4.2. Helper Function: `callGeminiAPI(prompt, temperature)`
*   **Description:** This is a private helper function that handles the API call logic.
*   **Functionality:**
    *   Retrieves the Gemini API key from `PropertiesService`.
    *   Constructs the JSON payload. The model is hardcoded to **`gemini-2.5-flash-lite-preview-06-17`**.
    *   Executes a `UrlFetchApp.fetch()` call to the Gemini API endpoint.
    *   Performs detailed parsing and error checking on the response.

**5. Data Flow**
1.  **Input:** A user enters the `=GEMINI()` formula into a cell.
2.  **Processing:**
    *   The Apps Script function reads the data from the specified `prompt_range`.
    *   The script constructs and sends a request to the Gemini API.
3.  **Output:**
    *   The script receives the response from the Gemini API.
    *   The generated text (or a detailed error) is returned to the cell containing the formula.

**6. Error Handling**
The script will implement robust `try-catch` blocks and response validation to provide descriptive, user-friendly error messages directly in the spreadsheet cell. Specific errors handled include:
*   **Missing API Key:** If the `GEMINI_API_KEY` is not found in Script Properties, the message "ERROR: Gemini API key not set. Please add it to Script Properties." will be returned.
*   **Invalid Input:** If the prompt range is empty or contains no text, an error like "ERROR: Prompt cannot be empty." will be returned.
*   **API Errors (e.g., 400 Bad Request):** If the API returns an error (e.g., due to an invalid key or malformed request), the message will be formatted as "ERROR: API call failed (Code 400): [Detailed message from API]".
*   **Server Errors (e.g., 500 Internal Server Error):** If the Gemini API experiences a server-side issue, "ERROR: API call failed with server error (Code 500)." will be shown.
*   **Safety Blocks:** If the API blocks the response for safety reasons, the message "ERROR: Response blocked for safety reasons. [Finish Reason]" will be displayed.
*   **Empty Response:** If the API returns a success code but no text, "ERROR: Received an empty or invalid response from the API." will be shown.
*   **Fetch Failures:** For network issues, a generic "ERROR: Failed to call the Gemini API: [Exception message]" will be returned.
